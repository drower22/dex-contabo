name: Deploy to Contabo

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (metadata only)
        uses: actions/checkout@v4

      - name: SSH ping (debug)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            echo "SSH OK on $(hostname)"

      - name: Remote deploy (Node + PM2 - JavaScript Puro)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_SSH_KEY }}
          port: 22
          script: |
            set -e
            APP_DIR=/home/dex/dex-app
            
            # 1. Limpar node_modules (mudar dono para root primeiro)
            if [ -d "$APP_DIR/node_modules" ]; then
              echo "ðŸ—‘ï¸  Limpando node_modules antigo..."
              chown -R root:root "$APP_DIR/node_modules" 2>/dev/null || true
              rm -rf "$APP_DIR/node_modules" "$APP_DIR/package-lock.json"
              echo "âœ… node_modules removido"
            fi
            
            # 2. Deploy como usuÃ¡rio dex
            sudo -u dex bash << 'EOF'
            set -e
            APP_DIR=/home/dex/dex-app
            
            # Atualizar cÃ³digo
            if [ ! -d "$APP_DIR/.git" ]; then
              git clone --branch main git@github.com:drower22/dex-contabo.git "$APP_DIR"
            fi
            cd "$APP_DIR"
            
            # Backup antes de atualizar
            BACKUP_DIR="backup_pre_deploy_$(date +%Y%m%d_%H%M%S)"
            mkdir -p "$BACKUP_DIR"
            cp -r api "$BACKUP_DIR/" 2>/dev/null || true
            cp ecosystem.config.js "$BACKUP_DIR/" 2>/dev/null || true
            echo "âœ… Backup criado em: $BACKUP_DIR"
            
            git fetch --all
            git reset --hard origin/main
            
            # Instalar dependÃªncias (node_modules jÃ¡ foi limpo como root)
            npm install
            
            # 3. Verificar se Ã© migraÃ§Ã£o para JavaScript
            if [ -f "api/server-node.js" ] && [ ! -f "api/server.js" ]; then
              echo "ðŸ”„ Detectada migraÃ§Ã£o para JavaScript..."
              
              # Renomear server-node.js para server.js se necessÃ¡rio
              if [ ! -f "api/server.js" ]; then
                cp api/server-node.js api/server.js
                echo "âœ… server.js criado"
              fi
              
              # Atualizar ecosystem.config.js se ainda estiver usando ts-node
              if grep -q "ts-node/register" ecosystem.config.js; then
                echo "âš ï¸  ecosystem.config.js ainda usa ts-node, atualizando..."
                sed -i "s|./api/server.ts|./api/server.js|g" ecosystem.config.js
                sed -i "/interpreter_args.*ts-node/d" ecosystem.config.js
                sed -i "/TS_NODE_PROJECT/d" ecosystem.config.js
                echo "âœ… ecosystem.config.js atualizado para JavaScript"
              fi
            fi
            
            # 4. Reiniciar PM2
            pm2 delete dex-api 2>/dev/null || true
            pm2 start ecosystem.config.js
            pm2 save
            
            # 5. Aguardar inicializaÃ§Ã£o
            echo "â³ Aguardando 5 segundos..."
            sleep 5
            
            # 6. Verificar health check
            echo "ðŸ§ª Testando health check..."
            HEALTH_STATUS=$(curl -s http://localhost:3000/api/ifood-auth/health | jq -r '.status' 2>/dev/null || echo "error")
            
            if [ "$HEALTH_STATUS" = "healthy" ]; then
              echo "âœ… Deploy concluÃ­do com sucesso!"
              pm2 status
            else
              echo "âŒ Health check falhou: $HEALTH_STATUS"
              echo "ðŸ”„ Tentando rollback..."
              
              # Rollback
              pm2 delete dex-api 2>/dev/null || true
              if [ -d "$BACKUP_DIR" ]; then
                cp -r "$BACKUP_DIR/api/"* api/ 2>/dev/null || true
                cp "$BACKUP_DIR/ecosystem.config.js" . 2>/dev/null || true
                pm2 start ecosystem.config.js
                echo "âš ï¸  Rollback executado. Verifique os logs."
              fi
              exit 1
            fi
            EOF
            
            # Recarregar Nginx (como root)
            sudo systemctl reload nginx 2>/dev/null || true
