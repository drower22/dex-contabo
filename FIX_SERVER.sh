#!/bin/bash
# ============================================================================
# Script de Corre√ß√£o do Servidor Contabo
# ============================================================================
# Execute como ROOT no servidor: bash FIX_SERVER.sh
# ============================================================================

set -e

echo "üîß Iniciando corre√ß√£o do servidor..."

# 1. Parar TODOS os processos PM2 (root e dex)
echo "1Ô∏è‚É£ Parando todos os PM2..."
pm2 kill || true
sudo -u dex pm2 kill || true

# 2. Matar processos node √≥rf√£os
echo "2Ô∏è‚É£ Matando processos node √≥rf√£os..."
pkill -9 -f "node.*dex-app" || true
sleep 2

# 3. Corrigir permiss√µes do diret√≥rio
echo "3Ô∏è‚É£ Corrigindo permiss√µes..."
chown -R dex:dex /home/dex/dex-app
chmod 755 /home/dex/dex-app

# 4. Limpar node_modules e reinstalar
echo "4Ô∏è‚É£ Limpando e reinstalando depend√™ncias..."
cd /home/dex/dex-app
rm -rf node_modules package-lock.json
sudo -u dex npm install

# 5. Iniciar PM2 como usu√°rio dex
echo "5Ô∏è‚É£ Iniciando PM2 como dex..."
sudo -u dex bash << 'EOF'
cd /home/dex/dex-app
pm2 delete all 2>/dev/null || true
pm2 start api/server.ts --name dex-api --interpreter ts-node --instances 2 --env production
pm2 save
pm2 startup
EOF

# 6. Verificar status
echo "6Ô∏è‚É£ Verificando status..."
sudo -u dex pm2 status

echo ""
echo "‚úÖ Corre√ß√£o conclu√≠da!"
echo ""
echo "üìä Processos node rodando:"
ps aux | grep node | grep -v grep

echo ""
echo "üß™ Teste a API:"
echo "curl http://localhost:3000/api/ifood-auth/health"
